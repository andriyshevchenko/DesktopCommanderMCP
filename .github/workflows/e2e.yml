name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      run_llm_tests:
        description: 'Run LLM tests (requires OPENAI_API_KEY secret)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  e2e-mcp:
    name: E2E Tests (MCP Protocol)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Verify Python installation
        run: |
          python3 --version
          pip3 --version
      
      - name: Install dependencies
        run: PUPPETEER_SKIP_DOWNLOAD=true npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: true
      
      - name: Build project
        run: npm run build
      
      - name: Run MCP E2E tests
        run: node test/test-python-executor-e2e.js
        timeout-minutes: 10
      
      - name: Test results
        if: always()
        run: echo "E2E MCP tests completed"
  
  e2e-llm:
    name: E2E Tests (LLM Integration)
    runs-on: ubuntu-latest
    # Run on push/PR events (checks for OPENAI_API_KEY availability inside the job)
    # or on manual trigger when explicitly requested
    # Note: We cannot check secret availability in job-level 'if' conditions,
    # so the job runs but skips test execution if the key is not configured
    if: |
      (github.event_name == 'push' || github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_llm_tests == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: PUPPETEER_SKIP_DOWNLOAD=true npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: true
      
      - name: Build project
        run: npm run build
      
      - name: Check for OpenAI API key
        id: check_key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "⚠️ OPENAI_API_KEY secret not configured"
            echo "LLM E2E tests will be skipped"
            echo "Configure the OPENAI_API_KEY secret in repository settings to enable LLM tests"
            echo "has_key=false" >> $GITHUB_OUTPUT
          else
            echo "✓ OPENAI_API_KEY is configured"
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Run LLM E2E tests
        if: steps.check_key.outputs.has_key == 'true'
        run: node test/test-python-executor-llm-e2e.js
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        timeout-minutes: 15
      
      - name: Test results
        if: always()
        run: |
          if [ "${{ steps.check_key.outputs.has_key }}" == "true" ]; then
            echo "E2E LLM tests completed"
          else
            echo "E2E LLM tests skipped (no API key)"
          fi
  
  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-mcp, e2e-llm]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.e2e-mcp.result }}" == "success" ]; then
            echo "✅ MCP E2E tests passed"
          else
            echo "❌ MCP E2E tests failed"
            exit 1
          fi
      
      - name: LLM tests status
        run: |
          RESULT="${{ needs.e2e-llm.result }}"
          if [ "$RESULT" == "success" ]; then
            echo "✅ LLM E2E tests passed"
          elif [ "$RESULT" == "skipped" ] || [ -z "$RESULT" ]; then
            echo "⏭️ LLM E2E tests skipped (job not scheduled or no OPENAI_API_KEY configured)"
          elif [ "$RESULT" == "failure" ]; then
            echo "⚠️ LLM E2E tests failed"
            # Don't fail the entire workflow if LLM tests fail
            # They might fail due to API issues, rate limits, etc.
          else
            echo "ℹ️ LLM E2E tests status: $RESULT"
          fi
