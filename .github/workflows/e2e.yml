name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      run_llm_tests:
        description: 'Run LLM tests (requires OPENAI_API_KEY secret)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  e2e-mcp:
    name: E2E Tests (MCP Protocol)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Verify Python installation
        run: |
          python3 --version
          pip3 --version
      
      - name: Install dependencies
        run: PUPPETEER_SKIP_DOWNLOAD=true npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: true
      
      - name: Build project
        run: npm run build
      
      - name: Run MCP E2E tests
        run: node test/test-python-executor-e2e.js
        timeout-minutes: 10
      
      - name: Test results
        if: always()
        run: echo "E2E MCP tests completed"
  
  e2e-llm:
    name: E2E Tests (LLM Integration)
    runs-on: ubuntu-latest
    # Only run on manual trigger or when explicitly enabled
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_llm_tests == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: PUPPETEER_SKIP_DOWNLOAD=true npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: true
      
      - name: Build project
        run: npm run build
      
      - name: Check for OpenAI API key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "⚠️ OPENAI_API_KEY secret not configured"
            echo "LLM E2E tests require OpenAI API access"
            echo "Configure the OPENAI_API_KEY secret in repository settings"
            exit 1
          fi
      
      - name: Run LLM E2E tests
        run: node test/test-python-executor-llm-e2e.js
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        timeout-minutes: 15
      
      - name: Test results
        if: always()
        run: echo "E2E LLM tests completed"
  
  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-mcp]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.e2e-mcp.result }}" == "success" ]; then
            echo "✅ MCP E2E tests passed"
          else
            echo "❌ MCP E2E tests failed"
            exit 1
          fi
      
      - name: LLM tests status
        run: |
          if [ "${{ needs.e2e-llm.result }}" == "success" ]; then
            echo "✅ LLM E2E tests passed"
          elif [ "${{ needs.e2e-llm.result }}" == "skipped" ]; then
            echo "⏭️ LLM E2E tests skipped (manual trigger required)"
          else
            echo "⚠️ LLM E2E tests status: ${{ needs.e2e-llm.result }}"
          fi
